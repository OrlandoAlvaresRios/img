<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ninja v1.12</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background-color: #143a61;
      color: white;
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      height: 100%;
      margin: 0;
      overflow: hidden;
    }

    .undo-label {
      color: red;
      cursor: pointer;
      font-weight: bold;
      margin-left: 10px;
    }

    .hidden {
      display: none;
    }

    LINninja {
      font-size: 24px;
      text-align: center;
      margin: 0;
      padding: 10px;
      background-color: #0d263f;
      border-bottom: 1px solid #007bff;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    textarea {
      width: calc(100% - 20px);
      padding: 10px;
      margin: 10px auto;
      border: 1px solid #0d263f;
      border-radius: 5px;
      background-color: #0d263f;
      color: white;
      resize: none;
      height: calc(2.5em);
      overflow: hidden;
    }

    textarea::placeholder {
      white-space: pre-wrap;
    }

    button {
      padding: 10px 15px;
      margin: 5px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      background-color: #007bff;
      color: white;
    }

    button:hover:enabled {
      background-color: #0056b3;
    }

    .button-container {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin: 10px 0;
    }

    #TXTresp {
      width: calc(100% - 20px);
      height: 320px;
      background-color: #0d263f;
      border-radius: 5px;
      padding: 5px 10px;
      font-family: monospace;
      margin: 5px auto;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }

    #TXTresp .header {
      background-color: #0d263f;
      color: white;
      padding: 5px 10px;
      font-size: 14px;
      font-family: monospace;
      border: 1px solid #007bff;
      border-radius: 5px;
      margin: 0 0 5px 0;
      text-align: left;
      pointer-events: none;
      position: relative;
    }

    #LINmsg {
      background-color: #4f8dcb;
      color: white;
      padding: 5px 10px;
      font-size: 14px;
      font-family: monospace;
      font-weight: bold;
      border: 1px solid #007bff;
      border-radius: 5px;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      white-space: nowrap;
      overflow: hidden;
      display: none;
      z-index: 1000;
      transition: none;
    }

    #TXTresp .line:focus {
      background-color: #66aaff;
    }

    #TXTresp .line {
      display: grid;
      grid-template-columns: 100px 60px 40px 60px auto;
      gap: 10px;
      padding: 5px;
      align-items: center;
    }

    #TXTresp .header {
      display: grid;
      grid-template-columns: 100px 60px 40px 60px auto;
      gap: 10px;
      padding: 5px;
      font-weight: bold;
    }

    /* Estilo para o valor monetário */
    .valor {
      text-align: right;
      font-family: monospace;
    }

    /* Estilo para a posição */
    .posic {
      text-align: center;
      font-family: monospace;
    }

    /* Estilo para o verificador */
    .ver {
      text-align: center;
      font-weight: bold;
    }

    #TXTresp::-webkit-scrollbar {
      width: 12px;
    }

    #TXTresp::-webkit-scrollbar-thumb {
      background-color: #007bff;
      border-radius: 6px;
    }

    #TXTresp::-webkit-scrollbar-thumb:hover {
      background-color: #0056b3;
    }

    #TXTresp::-webkit-scrollbar-track {
      background-color: #0d263f;
    }

    @media (max-width: 768px) {
      button {
        padding: 8px;
        margin: 3px;
      }

      textarea {
        height: 3em;
      }
    }

    .verified {
      color: #4CAF50;
      font-weight: bold;
    }

    .line {
      display: grid;
      grid-template-columns: 100px 60px 40px 60px auto;
      gap: 10px;
      padding: 8px 5px;
      border-bottom: 1px solid rgba(79, 141, 203, 0.2);
    }

    .line:hover {
      background-color: rgba(79, 141, 203, 0.1);
    }

    .valor {
      font-family: monospace;
      text-align: right;
      padding-right: 5px;
    }

    .posic {
      font-family: monospace;
      text-align: center;
    }

    .ver {
      text-align: center;
      font-weight: bold;
    }

    .code {
      font-family: monospace;
      text-align: center;
    }

    .button-special {
      background-color: #4f8dcb !important;
      border: 2px solid #ffffff !important;
      font-weight: bold !important;
      padding: 10px 20px !important;
      box-shadow: 0 0 5px rgba(0, 0, 0, 0.3) !important;
    }

    .button-special:hover {
      background-color: #66aaff !important;
      transform: scale(1.05);
      transition: all 0.2s ease;
    }

    .filter-group {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .filter-group label {
      color: white;
      font-size: 0.9em;
    }

    .filter-group select,
    .filter-group input {
      padding: 3px;
      border-radius: 3px;
      border: 1px solid #4f8dcb;
      background-color: #0d263f;
      color: white;
    }

    .hidden {
      display: none;
    }

    #BTNexport {
      margin-left: auto;
      background-color: #4CAF50;
    }

    #BTNexport:hover {
      background-color: #45a049;
    }


    .header {
      display: grid;
      grid-template-columns: 100px 80px 50px 80px auto;
      gap: 10px;
      padding: 10px;
      background-color: #0d263f;
      border-bottom: 2px solid #4f8dcb;
      font-weight: bold;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    .line {
      display: grid;
      grid-template-columns: 100px 80px 50px 80px auto;
      gap: 10px;
      padding: 8px 10px;
      border-bottom: 1px solid rgba(79, 141, 203, 0.2);
      align-items: center;
    }

    .valor {
      text-align: right;
      font-family: monospace;
    }

    .posic {
      text-align: center;
      font-family: monospace;
    }

    .ver {
      text-align: center;
      font-weight: bold;
    }

    .code {
      text-align: center;
      font-family: monospace;
    }

    .item {
      text-align: left;
    }
  </style>
</head>

<body>
  <LINninja>Ninja v1.12
    <div id="LINmsg">...</div>
  </LINninja>

  <textarea id="TXTquest" rows="1" tabindex="1"></textarea>

  <div class="button-container">
    <button id="BTNcls" tabindex="3">Limpar</button>
    <button id="BTNhelp" tabindex="4">Ajuda</button>
    <!-- Separador visual -->
    <span style="margin: 0 15px; border-left: 1px solid #4f8dcb; height: 20px; display: inline-block;"></span>
    <!-- Botões especiais -->
    <button id="BTNorc" tabindex="5" onclick="FNCorcamento()" class="button-special">[O] Orçamento</button>
    <button id="BTNvenda" tabindex="6" onclick="FNCVenda()" class="button-special">[V] Venda</button>
  </div>

  <div class="button-container">
    <button id="BTNedit" tabindex="5">Editar</button>
    <button class="BTNdelete" tabindex="6">Deletar</button>
    <button class="BTNcreate" tabindex="7">Cadastrar</button>
  </div>

  <div id="TXTresp" tabindex="8">
    <div class="header">Valor | Posic | Ver | Code | Item</div>
  </div>

  <div id="editModal" style="
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: rgba(20, 58, 97, 0.95);
        padding: 20px;
        border-radius: 5px;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        border: 2px solid #4f8dcb;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);">
    <div style="
          background-color: rgba(20, 58, 97, 0.95);
          padding: 20px;
          border-radius: 5px;
          width: 300px;
          color: white;">
      <div style="
            background-color: #4f8dcb;
            color: white;
            padding: 5px;
            text-align: center;
            border-radius: 5px;
            margin-bottom: 15px;
            font-weight: bold;">
        Editar Item Selecionado
      </div>

      <label for="editValor">Valor:</label>
      <input type="text" id="editValor" style="width: 100%; margin-bottom: 10px" maxlength="13"
        placeholder="999.999,00" />

      <label for="editPosic">Posic:</label>
      <input type="text" id="editPosic" style="width: 100%; margin-bottom: 10px" maxlength="5" placeholder="99999" />

      <label for="editVer">Verificado S/N:</label>
      <input type="text" id="editVer" style="width: 100%; margin-bottom: 10px" maxlength="1" placeholder="S/N" />




      <label for="editCode">Code:</label>
      <input type="text" id="editCode" style="width: 100%; margin-bottom: 10px" disabled />

      <label for="editItem">Item:</label>
      <input type="text" id="editItem" style="width: 100%; margin-bottom: 20px" />

      <div class="button-container" style="justify-content: space-between">
        <button id="BTNsave" onclick="FNCmakeEDIT()">Salvar</button>
        <button id="BTNcancel" onclick="FNCcloseEDIT()">Cancelar</button>
      </div>
    </div>
  </div>

  <div id="VARcreateModal" style="
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: rgba(20, 58, 97, 0.95);
        padding: 20px;
        border-radius: 5px;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        border: 2px solid #4f8dcb;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);">
    <div style="
          background-color: rgba(20, 58, 97, 0.95);
          padding: 20px;
          border-radius: 5px;
          width: 300px;
          color: white;">
      <div style="
            background-color: #4f8dcb;
            color: white;
            padding: 5px;
            text-align: center;
            border-radius: 5px;
            margin-bottom: 15px;
            font-weight: bold;">
        Cadastrar Novo Item
      </div>

      <label for="VARnewValor">Valor:</label>
      <input type="text" id="VARnewValor" style="width: 100%; margin-bottom: 10px" maxlength="13"
        placeholder="999.999,00" />

      <label for="VARnewPosic">Posic:</label>
      <input type="text" id="VARnewPosic" style="width: 100%; margin-bottom: 10px" maxlength="5" placeholder="99999" />

      <label for="VARnewVer">Verificado S/N:</label>
      <input type="text" id="VARnewVer" style="width: 100%; margin-bottom: 10px" maxlength="1" value="N"
        placeholder="S/N" />

      <label for="VARnewCode">Code:</label>
      <input type="text" id="VARnewCode" style="width: 100%; margin-bottom: 10px" disabled />
      <label for="VARnewItem">Item:</label>
      <input type="text" id="VARnewItem" style="width: 100%; margin-bottom: 20px" />

      <div class="button-container" style="justify-content: space-between">
        <button id="BTNcreate" onclick="FNCmakeCreate()">Cadastrar</button>
        <button id="BTNcancelCreate" onclick="FNCcloseCreate()">Cancelar</button>
      </div>
    </div>
  </div>

  <div id="filterArea" style="
    background-color: #143a61;
    padding: 10px;
    margin: 10px;
    border-radius: 5px;
    display: flex;
    gap: 10px;
    align-items: center;
">

    <div class="filter-group">
      <label>Valor:</label>
      <select id="filterValor">
        <option value="">Todos</option>
        <option value="menor">Menor que...</option>
        <option value="maior">Maior que...</option>
        <option value="entre">Entre...</option>
      </select>
      <input type="text" id="valorMin" placeholder="Min" style="width: 80px" />
      <input type="text" id="valorMax" placeholder="Max" style="width: 80px" class="hidden" />
    </div>

    <div class="filter-group">
      <label>Verificado:</label>
      <select id="filterVer">
        <option value="">Todos</option>
        <option value="S">Sim</option>
        <option value="N">Não</option>
      </select>
    </div>

    <button id="BTNexport" onclick="FNCexportData()">
      Exportar Dados
    </button>
  </div>

  <script>
    const BTNsave = document.getElementById("BTNsave"); //Botão de salvar
    const BTNcancel = document.getElementById("BTNcancel"); //Botão de cancelar
    const BTNcls = document.getElementById("BTNcls"); //Botão de limpar
    const BTNhelp = document.getElementById("BTNhelp"); //Botão de ajuda
    const TXTsearch = document.getElementById("TXTquest"); //Campo de pesquisa
    const LSTresp = document.getElementById("TXTresp"); //Lista de respostas
    const LINmsg = document.getElementById("LINmsg"); //Mensagem de status
    const FName = "itens.dbf"; //Nome do arquivo
    let TLine = null; //Linha selecionada
    const Furl =
      "https://raw.githubusercontent.com/OrlandoAlvaresRios/itens/refs/heads/main/itens.dbf"; //URL do arquivo

    function FNCexportData() {
      const data = localStorage.getItem(FName);
      if (!data) {
        FNCshowMessage("Sem dados para exportar");
        return;
      }

      // Pega linhas filtradas
      const lines = data.split('\n')
        .map(line => line.trim())
        .filter(line => line.length > 0);

      const filteredLines = FNCapplyFilters(lines);

      // Cria CSV
      const csv = [
        'Valor;Posição;Verificado;Código;Item', // Header
        ...filteredLines.map(line => line.replace(/\|/g, ';'))
      ].join('\n');

      // Cria Blob e link para download
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);

      link.setAttribute('href', url);
      link.setAttribute('download', 'dados_exportados.csv');
      link.style.visibility = 'hidden';

      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    function FNCapplyFilters(lines) {
      const valorFilter = document.getElementById('filterValor').value;
      const verFilter = document.getElementById('filterVer').value;
      const valorMin = parseFloat(document.getElementById('valorMin').value.replace(',', '.')) || 0;
      const valorMax = parseFloat(document.getElementById('valorMax').value.replace(',', '.')) || 999999;

      return lines.filter(line => {
        const [valor, , ver] = line.split('|');
        const numValor = parseFloat(valor.replace('.', '').replace(',', '.'));

        // Filtro de valor
        let passValor = true;
        switch (valorFilter) {
          case 'menor':
            passValor = numValor <= valorMin;
            break;
          case 'maior':
            passValor = numValor >= valorMin;
            break;
          case 'entre':
            passValor = numValor >= valorMin && numValor <= valorMax;
            break;
        }

        // Filtro de verificação
        const passVer = !verFilter || ver.trim() === verFilter;

        return passValor && passVer;
      });
    }

    function FNCupdateTotals(filteredLines) {
      const totals = filteredLines.reduce((acc, line) => {
        const [valor, , ver] = line.split('|').map(part => part.trim());
        const numValor = parseFloat(valor.replace('.', '').replace(',', '.'));
        return {
          totalItens: acc.totalItens + 1,
          totalValor: acc.totalValor + numValor,
          verificados: acc.verificados + (ver.toUpperCase() === 'S' ? 1 : 0)
        };
      }, { totalItens: 0, totalValor: 0, verificados: 0 });

      document.getElementById('totalItens').textContent = totals.totalItens;
      document.getElementById('totalValor').textContent =
        FNCformatMoney(totals.totalValor.toString());
      document.getElementById('totalVerificados').textContent =
        `${totals.verificados}/${totals.totalItens}`;
    }

    function FNCvalidateNumericInput(input, maxLength) { //Validação de entrada numérica
      input.addEventListener('keypress', function (e) { //Adiciona evento de keypress ao campo
        // Permite apenas números
        if (!/\d/.test(e.key)) { //Se a tecla pressionada não é um número
          e.preventDefault();
        }
        if (this.value.length >= maxLength) { //Se o valor atual é maior que o máximo
          e.preventDefault();
        }
      });
    }

    FNCvalidateNumericInput(document.getElementById('editPosic'), 5); //Valida a posição

    FNCvalidateNumericInput(document.getElementById('VARnewPosic'), 5); //Valida a posição

    function FNCformatMoney(value) {
      if (!value) return 'R$ 0,00';

      // Remove qualquer caractere não numérico
      const numValue = parseFloat(value.replace(/[^\d,]/g, '').replace(',', '.'));

      return new Intl.NumberFormat('pt-BR', {
        style: 'currency',
        currency: 'BRL',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      }).format(numValue);
    }

    function FNCselectLine(element) {
      // Remove seleção anterior
      const previousSelected = document.querySelector('.line.selected');
      if (previousSelected) {
        previousSelected.classList.remove('selected');
      }

      // Adiciona nova seleção
      element.classList.add('selected');
      TLine = element;

      // Extrai dados da linha de forma correta
      const spans = element.querySelectorAll('span');
      const valor = spans[0].textContent.trim();
      const posic = spans[1].textContent.trim();
      const ver = spans[2].textContent.trim();
      const code = spans[3].textContent.trim();
      const item = spans[4].textContent.trim();

      // Atualiza campos do modal de edição
      document.getElementById('editValor').value = valor.replace('R$', '').trim();
      document.getElementById('editPosic').value = posic;
      document.getElementById('editVer').value = ver;
      document.getElementById('editCode').value = code;
      document.getElementById('editItem').value = item;

      FNCshowMessage(`Item selecionado: ${item}`);
    }

    function FNCcreateLine(data) { //Função para criar linha
      const [valor, posic, ver, code, item] = data.split("|").map(part => part.trim());
      return `
        <div class="line" tabindex="0" data-code="${code}">
            <span class="valor">${FNCformatMoney(valor)}</span>
            <span class="posic">${posic.padStart(5, '0')}</span>
            <span class="ver">${ver.toUpperCase()}</span>
            <span class="code">${code}</span>
            <span class="item">${item}</span>
        </div>
    `;
    }

    function FNCformatMoney(value) { //Função para formatar valor monetário
      return parseFloat(value) //Converte para número
        .toLocaleString('pt-BR', { //Formata para o padrão brasileiro
          minimumFractionDigits: 2, //Mínimo de 2 casas decimais
          maximumFractionDigits: 2 //Máximo de 2 casas decimais
        });
    }

    function FNCvalidateValor(input) { // Validação do valor monetário
      input.addEventListener('input', function (e) { //Adiciona evento de input ao campo de valor
        let value = e.target.value.replace(/\D/g, ''); //Remove tudo que não é número
        value = (parseFloat(value) / 100).toFixed(2); //Converte para número e formata
        e.target.value = value.replace('.', ','); //Formata o valor
      });
    }

    function FNCvalidatePosic(input) { //Validação da posição
      input.addEventListener('input', function (e) { //Adiciona evento de input ao campo de posição
        e.target.value = e.target.value.replace(/\D/g, '').substr(0, 5); //Remove tudo que não é número e limita a 5 caracteres
      });
    }

    function FNCvalidateVer(input) { //Validação do verificador
      input.addEventListener('input', function (e) { //Adiciona evento de input ao campo de verificador
        let value = e.target.value.toUpperCase(); //Converte para maiúsculas
        if (value && value !== 'S' && value !== 'N') { //Se o valor não é S ou N
          value = 'N'; //Converte para N
        }
        e.target.value = value;
      });
    }

    document.addEventListener('DOMContentLoaded', function () { //Adiciona evento de carregamento do DOM
      FNCvalidateValor(document.getElementById('editValor')); //Valida o valor
      FNCvalidatePosic(document.getElementById('editPosic')); //Valida a posição
      FNCvalidateVer(document.getElementById('editVer')); //Valida o verificador

      FNCvalidateValor(document.getElementById('VARnewValor')); //Valida o valor
      FNCvalidatePosic(document.getElementById('VARnewPosic')); //Valida a posição
      FNCvalidateVer(document.getElementById('VARnewVer')); //Valida o verificador
    });

    function FNCformatInputValue(value) { //Função para formatar valor monetário
      value = value.replace(/\D/g, ''); //Remove tudo que não é número
      value = (value / 100).toFixed(2); //Converte para número e formata
      return value.replace('.', ','); //Formata o valor
    }

    document.getElementById('editValor').addEventListener('blur', function (e) { //Adiciona evento de input ao campo de valor
      e.target.value = FNCformatInputValue(e.target.value); //Formata o valor
    });

    document.getElementById('VARnewValor').addEventListener('blur', function (e) {
      e.target.value = FNCformatInputValue(e.target.value);
    });

    function FNCdebounce(FNCfunc, VARdelay) { //Função para criar delay
      let VARtimeoutId; //Variável para armazenar o ID do timeout
      return function (...args) { //Função que cria o delay
        clearTimeout(VARtimeoutId); //Limpa o timeout anterior
        VARtimeoutId = setTimeout(() => { //Cria um novo timeout
          FNCfunc.apply(this, args); //Aplica a função com os argumentos
        }, VARdelay); //Tempo de delay
      };
    }

    function loadFile() { //Função para carregar o arquivo
      const storedData = localStorage.getItem(FName); //Obtém os dados do localStorage
      if (storedData == null) { //Se não há dados
        FNCrefdatabase(); //Refaz a base de dados
      }
      FNCSearchData(""); //Exibe os dados
    }

    document.querySelector(".BTNdelete").addEventListener("click", function () {
      if (!TLine) {
        FNCshowMessage("Pesquise e clique em item para continuar");
        return;
      }

      // Pega os valores corretamente dos spans
      const spans = TLine.querySelectorAll('span');
      const code = spans[3].textContent.trim(); // Código está na posição 3
      const item = spans[4].textContent.trim(); // Item está na posição 4

      if (window.confirm(`Deletar o registro selecionado?\n[${code}] ${item}`)) {
        const dados = localStorage.getItem(FName);
        const linhas = dados.split('\n')
          .map(linha => linha.trim())
          .filter(linha => linha.length > 0);

        // Filtra removendo a linha com o código correspondente
        const novasLinhas = linhas.filter(linha => {
          const [, , , lineCode] = linha.split('|').map(part => part.trim());
          return lineCode !== code;
        });

        if (linhas.length !== novasLinhas.length) {
          localStorage.setItem(FName, novasLinhas.join('\n'));
          FNCSearchData("");
          FNCshowMessage("Item deletado com sucesso!");
          TLine = null;
        } else {
          FNCshowMessage("Item não encontrado para deleção!");
          TLine = null;
        }
      } else {
        FNCshowMessage("Operação cancelada pelo usuário");
        TLine = null;
      }
    });

    function FNCopenED(line) {
      FNChabilitaBTN(false);

      // Pega os valores corretamente dos spans
      const spans = line.querySelectorAll('span');
      const valor = spans[0].textContent.replace('R$', '').trim();
      const posic = spans[1].textContent.trim();
      const ver = spans[2].textContent.trim();
      const code = spans[3].textContent.trim();
      const item = spans[4].textContent.trim();

      // Preenche os campos corretamente
      document.getElementById("editValor").value = valor;
      document.getElementById("editPosic").value = posic;
      document.getElementById("editVer").value = ver;
      document.getElementById("editCode").value = code;
      document.getElementById("editItem").value = item;

      document.getElementById("editModal").style.display = "flex";
      FNCshowMessage("Editar item selecionado");
    }

    function FNCcloseEDIT() { //Função para fechar o modal de edição
      FNChabilitaBTN(true); //Reabilita botões principais
      document.getElementById("editModal").style.display = "none"; //Fecha o modal
      FNCshowMessage("Editar item cancelada"); //Mensagem de sucesso
      TLine = null; //Limpa o item selecionado
    }

    function FNCnormalizeText(text) {
      return text
        .toLowerCase() // converte para caixa baixa
        .replace(/\s+/g, ' ') // remove espaços duplos
        .trim(); // remove espaços do início e fim
    }

    function FNCmakeEDIT() {
      let valor = document.getElementById("editValor").value.trim();
      const posic = document.getElementById("editPosic").value.trim();
      const ver = document.getElementById("editVer").value.trim().toUpperCase();
      const code = document.getElementById("editCode").value.trim();
      let item = document.getElementById("editItem").value;

      // Normaliza o texto do item
      item = FNCnormalizeText(item);

      // Trata o valor para garantir formato correto
      valor = valor.replace('R$', '').replace(/\./g, '').replace(',', '.');
      if (isNaN(parseFloat(valor))) {
        FNCshowMessage("Valor inválido");
        return;
      }

      valor = parseFloat(valor).toFixed(2);

      if (!valor || !posic || !ver || !item) {
        FNCshowMessage("Todos os campos são obrigatórios");
        return;
      }

      if (!/^[SN]$/.test(ver)) {
        FNCshowMessage("Verificador deve ser S ou N");
        return;
      }

      const newLine = `${valor}|${posic}|${ver}|${code}|${item}`;

      const data = localStorage.getItem(FName);
      if (data) {
        const lines = data.split('\n').filter(line => line.trim());
        const updatedLines = lines.map(line => {
          const [, , , lineCode] = line.split('|');
          return lineCode.trim() === code ? newLine : line;
        });

        localStorage.setItem(FName, updatedLines.join('\n'));
        FNCSearchData("");
        FNCcloseEDIT();
        FNCshowMessage("Item editado com sucesso!");
      }
    }

    function FNCmakeCreate() { //Função para criar novo item
      let valor = document.getElementById("VARnewValor").value.trim();
      const posic = document.getElementById("VARnewPosic").value.trim();
      const ver = document.getElementById("VARnewVer").value.trim().toUpperCase();
      const code = document.getElementById("VARnewCode").value.trim();
      let item = document.getElementById("VARnewItem").value;

      item = FNCnormalizeText(item);

      valor = valor.replace('R$', '').replace(/\./g, '').replace(',', '.');
      if (isNaN(parseFloat(valor))) {
        FNCshowMessage("Valor inválido");
        return;
      }

      valor = parseFloat(valor).toFixed(2);

      if (!valor || !posic || !ver || !item) {
        FNCshowMessage("Todos os campos são obrigatórios");
        return;
      }

      if (!/^[SN]$/.test(ver)) {
        FNCshowMessage("Verificador deve ser S ou N");
        return;
      }

      const newLine = `${valor}|${posic}|${ver}|${code}|${item}`;

      const data = localStorage.getItem(FName);
      const lines = data ? data.split('\n').filter(line => line.trim()) : [];
      lines.push(newLine);

      lines.sort((a, b) => {
        const codeA = a.split('|')[3];
        const codeB = b.split('|')[3];
        return codeA.localeCompare(codeB);
      });

      localStorage.setItem(FName, lines.join('\n'));
      FNCSearchData("");
      FNCcloseCreate();
      FNCshowMessage("Item cadastrado com sucesso!");
    }

    function FNCupdateBTN() { //Função para atualizar os textos dos botões
      TXTsearch.placeholder = "Digite aqui item a pesquisar, ex. Lampada ou digite 0013 e pesquise pelo Code. Se deixar vazio e teclar Enter carrego todos os Itens.";

      BTNcancel.innerText = "[ESC] Cancelar"; //Texto do botão de cancelar
      BTNcls.innerText = "[ESC] Limpar"; //Texto do botão de limpar
      BTNhelp.innerText = "[F1] Ajuda"; //Texto do botão de ajuda
      BTNsave.innerText = "[ENTER] Salvar"; //Texto do botão de salvar
      document.getElementById("BTNcreate").innerText = "[ENTER] Cadastrar"; //Texto do botão de cadastrar
      document.getElementById("BTNcancelCreate").innerText = "[ESC] Cancelar"; //Texto do botão de cancelar
      document.getElementById("BTNedit").innerText = "[E] Editar"; //Texto do botão de editar
      document.querySelector(".BTNdelete").innerText = "[D] Deletar"; //Texto do botão de deletar
      document.querySelector(".BTNcreate").innerText = "[C] Cadastrar"; //Texto do botão de cadastrar

      if (window.innerWidth <= 768) { //Se a tela é pequena
        BTNcls.innerText = "Limpar"; //Texto do botão de limpar
        BTNhelp.innerText = "Ajuda"; //Texto do botão de ajuda
        BTNsave.innerText = "Salvar"; //Texto do botão de salvar
        BTNcancel.innerText = "Cancelar"; //Texto do botão de cancelar
        document.getElementById("BTNedit").innerText = "Editar"; //Texto do botão de editar
        document.querySelector(".BTNdelete").innerText = "Deletar"; //Texto do botão de deletar
        document.querySelector(".BTNcreate").innerText = "Cadastrar"; //Texto do botão de cadastrar
        document.getElementById("BTNcreate").innerText = "Cadastrar"; //Texto do botão de cadastrar
        document.getElementById("BTNcancelCreate").innerText = "Cancelar"; //Texto do botão de cancelar
      }
    }

    function FNCnormSTR(str) { //Função para normalizar a string
      const replacements = { //Substituição de caracteres acentuados
        á: "a", //Substituição de caracteres acentuados
        à: "a",
        é: "e",
        ê: "e",
        í: "i",
        ó: "o",
        ô: "o",
        ú: "u",
        ç: "c",
        õ: "o",
        ã: "a",
        â: "a",
        ü: "u",
      };
      return str //Converte para minúsculas  
        .toLowerCase() //Converte para minúsculas
        .normalize("NFD") //Normaliza a string
        .replace(/[\u0300-\u036f]/g, "") //Remove caracteres acentuados
        .replace(/[áàéêíóôúçãâü]/g, (match) => replacements[match] || match) //Substitui caracteres acentuados
        .replace(/\s+/g, " ") //Substitui múltiplos espaços por um único espaço
    }

    function FNCsearch() { //Função para pesquisar
      const query = FNCnormSTR(TXTsearch.value); //Normaliza a string
      TXTsearch.value = query; //Preenche o campo de pesquisa
      FNCSearchData(query); //Pesquisa os itens
    }

    function FNCSearchData(searchTerm) {
      const data = localStorage.getItem(FName);
      if (!data) {
        FNCshowMessage("Sem dados para exibir");
        return;
      }

      // Limpa e adiciona cabeçalho
      LSTresp.innerHTML = `
        <div class="header">
            <span class="valor">Valor</span>
            <span class="posic">Posic</span>
            <span class="ver">Ver</span>
            <span class="code">Code</span>
            <span class="item">Item</span>
        </div>
    `;

      const lines = data.split('\n')
        .map(line => line.trim())
        .filter(line => line.length > 0);

      if (lines.length === 0) {
        FNCshowMessage("Nenhum item encontrado");
        return;
      }

      const searchTermLower = searchTerm.toLowerCase();

      const filteredLines = lines.filter(line => {
        const parts = line.split('|').map(part => part.trim());
        if (parts.length !== 5) return false;

        const [valor, posic, ver, code, item] = parts;
        return item.toLowerCase().includes(searchTermLower) ||
          code.includes(searchTermLower) ||
          posic.includes(searchTermLower) ||
          valor.includes(searchTermLower);
      });

      filteredLines.forEach(line => {
        const [valor, posic, ver, code, item] = line.split('|').map(part => part.trim());
        const formattedLine = `
            <div class="line" tabindex="0" onclick="FNCselectLine(this)">
                <span class="valor">${FNCformatMoney(valor)}</span>
                <span class="posic">${posic.padStart(5, '0')}</span>
                <span class="ver ${ver.toLowerCase() === 's' ? 'verified' : ''}">${ver}</span>
                <span class="code">${code}</span>
                <span class="item">${item}</span>
            </div>
        `;
        LSTresp.innerHTML += formattedLine;
      });
    }

    function FNChelp() {
      if (window.innerWidth <= 768) { //Verifica se a tela é pequena
        LSTresp.innerHTML =
          "Digite na caixa de Pesquisa acima um item a pesquisar ou parte dele,\
        ex. Digite Lampada ou 0010 para pesquisar pelo Code depois clique Pesquisar ou Limpar.<br><br>\
        [A pesquisa não é sensível a letras maiúsculas ou minúsculas, palavras acentuadas ou múltiplos espaços]<br><br>\
        Faça uma pesquisa clique no item desejado antes e depois em Editar o item Deletar o item ou C\
        para Cadastrar novo item. Clicando num item o texto do item é transportado para o campo de cadastro e\
        se não clicar num item antes o campo de cadastro é limpo."

      } else { //Se a tela é grande

        LSTresp.innerHTML =
          "Digite na caixa de Pesquisa acima um item a pesquisar ou parte dele,\
        ex. Digite Lampada ou 0010 para pesquisar pelo Code depois dê ENTER ou ESC para limpar.<br><br>\
        [A pesquisa não é sensível a letras maiúsculas ou minúsculas, palavras acentuadas ou múltiplos espaços]<br><br>\
        Faça uma pesquisa clique no item desejado antes e depois digite a letra E para Editar o item, D para Deletar ou\
        C para Cadastrar novo item. Clicando num item o texto do item é transportado para o campo de cadastro do item e\
        não clicando num item antes o campo de cadastro é limpo."
      }
      FNCshowMessage("Ajuda exibida"); //Mensagem de ajuda exibida
      TLine = null; //Limpa o item selecionado
    }

    function FNCshowconfirm(message) {
      return new Promise((resolve) => {
        const result = window.confirm(message);
        if (result) {
          FNCshowMessage("Operação confirmada");
        }
        resolve(result);
      });
    }

    function FNCshowError(message) {
      const msgElement = document.getElementById("LINmsg");
      msgElement.innerHTML = message;
      msgElement.style.backgroundColor = "#ff4444";
      msgElement.style.display = "block";

      setTimeout(() => {
        msgElement.style.display = "none";
        msgElement.style.backgroundColor = "#4f8dcb"; // volta à cor original
      }, 3000);
    }

    function FNCshowMessage(message) {
      const msgElement = document.getElementById("LINmsg");
      msgElement.innerHTML = message;
      msgElement.style.display = "block";

      // Esconde a mensagem após 6 segundos
      setTimeout(() => {
        msgElement.style.display = "none";
      }, 6000);
    }

    function FNCclean() { //Limpa a pesquisa
      TXTsearch.value = ""; //Limpa o campo de pesquisa
      TLine = null; //Limpa o item selecionado
      FNCupdateBTN(); //Atualiza os botões
      loadFile(); //Carrega os dados
      FNCshowMessage("Bem-vindo ao Ninja!"); //Mensagem de boas-vindas
    }

    function FNCorcamento() {
      FNCshowMessage("Em desenvolvimento. Aguarde.");
    }

    function FNCvenda() {
      FNCshowMessage("Em desenvolvimento. Aguarde.");
      // Futuramente aqui virá a lógica do módulo de vendas
    }

    document.getElementById("BTNvenda").addEventListener("click", function () {
      FNCvenda();
    });

    document.addEventListener("keydown", function (event) { // Adicionar eventos de tecla
      if (!document.activeElement.matches('input, textarea')) { // Verifica se não está em modal ou input
        if (event.key.toLowerCase() === 'o') { // Verifica se a tecla pressionada é O
          event.preventDefault(); //Previne o comportamento padrão do evento
          FNCorcamento(); //Chama a função de orçamentos
        } else if (event.key.toLowerCase() === 'v') {
          event.preventDefault();
          FNCvenda();
        }
      }
    }
    );

    BTNcls.addEventListener("click", () => {
      TXTsearch.value = "";
      FNCSearchData("");
      FNCshowMessage("Pesquisa limpa");
    });

    BTNhelp.addEventListener("click", FNChelp); //Adiciona evento de clique para ajuda

    document.addEventListener("keydown", (event) => { //Adiciona evento de tecla para o modal de edição
      const editModal = document.getElementById("editModal"); //Obtém o modal de edição
      if (editModal.style.display === "flex") { //Verifica se o modal está aberto
        if (event.key === "Enter") { //Verifica se a tecla pressionada é Enter
          event.preventDefault(); //Previne o comportamento padrão do evento
          FNCmakeEDIT(); //Chama a função para salvar a edição
        }
        if (event.key === "Escape") { //Verifica se a tecla pressionada é Escape
          event.preventDefault(); //Previne o comportamento padrão do evento
          FNCcloseEDIT(); //Fecha o modal de edição
        }
      }
    });

    window.addEventListener("keydown", (event) => { //Adiciona evento de tecla para pesquisa
      if (event.key === "Enter") { //Verifica se a tecla pressionada é Enter
        event.preventDefault(); //Previne o comportamento padrão do evento
        FNCsearch(); //Chama a função de pesquisa
      }
      if (event.key === "Escape") { //Verifica se a tecla pressionada é Escape
        event.preventDefault(); //Previne o comportamento padrão do evento
        FNCclean(); //Chama a função de limpar
      }
      if (event.key === "F1") { //Verifica se a tecla pressionada é F1
        event.preventDefault(); //Previne o comportamento padrão do evento
        FNChelp(); //Chama a função de ajuda
      }
    });

    document.getElementById("BTNedit").addEventListener("click", function () { //Adiciona evento de clique para o botão de editar
      if (!TLine) { //Verifica se não há item selecionado
        FNCshowMessage("Pesquise e clique em item para continuar"); //Mensagem de erro
        return; //Retorna se não há item selecionado
      }
      FNCopenED(TLine); //Abre o modal de edição com os dados da linha selecionada
    });

    document.addEventListener('DOMContentLoaded', function () {
      // Evento para mostrar/esconder campo de valor máximo
      document.getElementById('filterValor').addEventListener('change', function (e) {
        const valorMax = document.getElementById('valorMax');
        valorMax.classList.toggle('hidden', e.target.value !== 'entre');
      });

      // Atualizar lista quando filtros mudarem
      const filterElements = ['filterValor', 'filterVer', 'valorMin', 'valorMax'];
      filterElements.forEach(id => {
        document.getElementById(id).addEventListener('change', () => {
          FNCSearchData(document.getElementById('TXTquest').value);
        });
      });
    });

    function FNCopenCreate() {
      FNChabilitaBTN(false);

      // Obtém o maior código atual
      const data = localStorage.getItem(FName);
      const lines = data.split('\n').filter(line => line.trim());
      let maxCode = 0;

      lines.forEach(line => {
        const parts = line.split('|');
        const code = parseInt(parts[3]);
        if (code > maxCode) maxCode = code;
      });

      // Gera próximo código
      const newCode = String(maxCode + 1).padStart(4, '0');
      document.getElementById("VARnewCode").value = newCode;

      // Se houver item selecionado, transporta todos os dados
      if (TLine) {
        const spans = TLine.querySelectorAll('span');
        const valor = spans[0].textContent.trim().replace('R$', '').trim(); // Remove R$ e espaços
        const posic = spans[1].textContent.trim();
        const ver = spans[2].textContent.trim();
        const item = spans[4].textContent.trim();

        document.getElementById("VARnewValor").value = valor;
        document.getElementById("VARnewPosic").value = posic;
        document.getElementById("VARnewVer").value = ver;
        document.getElementById("VARnewItem").value = item;
      } else {
        // Se não houver item selecionado, limpa os campos
        document.getElementById("VARnewValor").value = "";
        document.getElementById("VARnewPosic").value = "";
        document.getElementById("VARnewVer").value = "N";
        document.getElementById("VARnewItem").value = "";
      }

      document.getElementById("VARcreateModal").style.display = "flex";
      FNCshowMessage("Cadastrar novo item");
    }

    function FNCcloseCreate() { //Fecha o modal de cadastro
      FNChabilitaBTN(true); //Reabilita botões principais
      document.getElementById("VARcreateModal").style.display = "none"; //Fecha o modal de cadastro
      TLine = null; //Limpa o item selecionado
      FNCshowMessage("Cadastro de novo item cancelado"); //Mensagem de sucesso
    }

    document.querySelector(".BTNcreate").addEventListener("click", FNCopenCreate); //Adiciona o evento ao botão Cadastrar existente

    document.addEventListener("keydown", (event) => { //Adiciona evento de tecla para o modal de cadastro
      const VARcreateModal = document.getElementById("VARcreateModal"); //Obtém o modal de cadastro
      if (VARcreateModal.style.display === "flex") { //Verifica se o modal está aberto
        switch (event.key) { //Verifica a tecla pressionada
          case "Enter":
            event.preventDefault(); //Previne o comportamento padrão do evento
            FNCmakeCreate(); //Chama a função para salvar o novo item
            break;
          case "Escape":
            event.preventDefault(); //Previne o comportamento padrão do evento
            FNCcloseCreate(); //Fecha o modal de cadastro
            break;
        }
      }
    });

    document.addEventListener("keydown", function (event) { //Adiciona eventos de tecla global para os atalhos

      const VARcreateModal = document.getElementById("VARcreateModal"); //Obtém o modal de cadastro
      const VAReditModal = document.getElementById("editModal"); //Obtém o modal de edição
      if (VARcreateModal.style.display === "flex" || //Verifica se o modal de cadastro está aberto
        VAReditModal.style.display === "flex" || //Verifica se o modal de edição está aberto
        event.target.tagName === "INPUT" || //Verifica se a tecla pressionada é um campo de input
        event.target.tagName === "TEXTAREA") { //Verifica se a tecla pressionada é um campo de textarea
        return; //Retorna se está em algum modal ou em campo de input/textarea
      }

      switch (event.key.toLowerCase()) { //Verifica a tecla pressionada
        case 'e': //Verifica se a tecla pressionada é E
          event.preventDefault(); //Previne o comportamento padrão do evento
          //Verifica se tem item selecionado antes de editar
          if (TLine) { //Verifica se tem item selecionado
            document.getElementById("BTNedit").click(); //Clica no botão de editar
          } else { //Se não tem item selecionado
            FNCshowMessage("Pesquise e clique em item para continuar"); //Mensagem de erro
          }
          break;
        case 'd': //Verifica se a tecla pressionada é D
          event.preventDefault(); //Previne o comportamento padrão do evento
          if (TLine) { //Verifica se tem item selecionado
            document.querySelector(".BTNdelete").click(); //Clica no botão de deletar
          } else { //Se não tem item selecionado
            FNCshowMessage("Pesquise e clique em item para continuar"); //Mensagem de erro
          }
          break;
        case 'c':
          event.preventDefault(); //Previne o comportamento padrão do evento
          document.querySelector(".BTNcreate").click(); //Clica no botão de cadastrar
          break;
      }
    });

    function FNCrefdatabase() { //Função para refazer a base de dados
      alert("Carregando dados de teste >");

      // Função auxiliar para gerar valores aleatórios
      function randomValue(min, max) {
        return Math.floor(Math.random() * (max - min + 1)) + min;
      }

      // Lista de produtos para gerar dados mais realistas
      const produtos = [
        "Lâmpada LED 9w",
        "Cabo flexível 2.5mm",
        "Disjuntor 20A",
        "Tomada 10A",
        "Interruptor simples",
        "Fita isolante 20m",
        "Extensão 5m",
        "Plafon LED",
        "Sensor presença",
        "Timer digital",
        "Chuveiro 220v",
        "Quadro distribuição",
        "Campainha sem fio",
        "Luminária pendente",
        "Plug macho 20A"
      ];

      // Gerar 50 registros
      let itens = [];
      for (let i = 1; i <= 50; i++) {
        const code = i.toString().padStart(4, '0');
        const valor = (randomValue(1000, 99999) / 100).toFixed(2);
        const posic = randomValue(1, 99999).toString().padStart(5, '0');
        const ver = Math.random() > 0.3 ? 'S' : 'N'; // 70% verificados
        const item = produtos[randomValue(0, produtos.length - 1)];

        itens.push(`${valor}|${posic}|${ver}|${code}|${item}`);
      }

      // Ordenar por código
      itens.sort((a, b) => {
        const codeA = a.split('|')[3];
        const codeB = b.split('|')[3];
        return codeA.localeCompare(codeB);
      });

      // Salvar no localStorage
      localStorage.setItem('itens.dbf', itens.join('\n'));

      FNCshowMessage("Base de dados carregada com sucesso!");

      // Atualizar a exibição
      FNCSearchData("");
    }

    function FNChabilitaBTN(VARstatus) { //Função para habilitar/desabilitar elementos da interface
      //Lista de botões principais para controlar
      const VARbotoes = [ //Lista de botões principais para controlar
        BTNcls, //Botão limpar
        BTNhelp, //Botão ajuda
        BTNorc, //Botão orçamento
        BTNvenda, //Botão venda
        document.getElementById("BTNedit"), //Botão editar
        document.querySelector(".BTNdelete"), //Botão deletar
        document.querySelector(".BTNcreate") //Botão cadastrar
      ];

      VARbotoes.forEach(botao => { //Itera sobre cada botão
        botao.disabled = !VARstatus; //Desabilita/habilita o botão
        botao.style.opacity = VARstatus ? "1" : "0.5"; //Altera a opacidade do botão
      });

      TXTsearch.disabled = !VARstatus; //Desabilita/habilita o campo de pesquisa
      TXTsearch.style.opacity = VARstatus ? "1" : "0.5";

      LSTresp.style.pointerEvents = VARstatus ? "auto" : "none"; //Controla o campo de pesquisa
      LSTresp.style.opacity = VARstatus ? "1" : "0.5"; //Altera a opacidade do campo de pesquisa
      LSTresp.tabIndex = VARstatus ? "8" : "-1"; //Remove da ordem de tabulação quando desabilitado
    }

    window.addEventListener("load", () => {
      localStorage.removeItem("itens.dbf");
      FNCupdateBTN();
      FNCrefdatabase(); // Primeiro recarrega a base
      loadFile();       // Depois carrega
      FNCSearchData(""); // Por fim exibe
      FNCshowMessage("Bem-vindo ao Ninja!");
    });
  </script>

  <div id="VARcreateModal" style="
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: #1e3a5d;
        padding: 20px;
        border-radius: 5px;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        border: 2px solid #1e3a5d;">
    <div style="
background-color: #1e3a5d;
padding: 20px;
border-radius: 5px;
width: 300px;
color: white;">
      <div style="
background-color: #4f8dcb;
color: white;
padding: 5px;
text-align: center;
border-radius: 5px;
margin-bottom: 15px;
font-weight: bold;">Cadastrar Novo Item</div>
      <label for="VARnewCode">Code:</label>
      <input type="text" id="VARnewCode" style="width: 100%; margin-bottom: 10px" disabled />
      <label for="VARnewItem">Item:</label>
      <input type="text" id="VARnewItem" style="width: 100%; margin-bottom: 20px" />
      <div class="button-container" style="justify-content: space-between">
        <button id="BTNcreate" onclick="FNCmakeCreate()">[ENTER] Cadastrar</button>
        <button id="BTNcancelCreate" onclick="FNCcloseCreate()">[ESC] Cancelar</button>
      </div>
    </div>
  </div>
</body>

</html>